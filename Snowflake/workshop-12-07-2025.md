
```
-- créer la base de données citbike

create or replace database citibike;



-- créer la table trips

create or replace table trips
(tripduration integer,
starttime timestamp,
stoptime timestamp,
start_station_id integer,
start_station_name string,
start_station_latitude float,
start_station_longitude float,
end_station_id integer,
end_station_name string,
end_station_latitude float,
end_station_longitude float,
bikeid integer,
membership_type string,
usertype string,
birth_year integer,
gender integer);


Select * from trips;

-- Create external S3 stage 

create or replace stage citibike_csv  URL ='s3://logbrain-datalake/datasets/citibike-trips-csv/';

list @citibike_csv;

-- créer un format de fichier csv 

CREATE or replace FILE FORMAT csv 
TYPE = 'CSV' 
FIELD_DELIMITER = ',' 
RECORD_DELIMITER = '\n' 
SKIP_HEADER = 1
field_optionally_enclosed_by = '\042'
null_if = ('');


show file formats in database citibike;


-- Charger les données dans la table trips
copy into trips from @citibike_csv file_format=csv PATTERN = '.*csv.*' ;


select * from trips;


- Categrorisation par tranche d'age
select case 
            when age between 5 and 10 then 'Enfants'
            when age between 11 and 17  then 'Ados'
            when age between 18 and 24 then 'Post_ados'
            when age between 25 and 49  then 'Adultes'
            when age between 50 and 74  then 'Seniors'
            when age between 75 and  100  then 'Ainés'
            Else 'Inconnus'
        end as categories_age
from (
    select (year(current_date()) - birth_year) as age from trips
    );


-- Nombre de trajets par categorie d'age

select  sum(nb_trip) as trips,   case 
            when age between 5 and 10 then 'Enfants'
            when age between 11 and 17  then 'Ados'
            when age between 18 and 24 then 'Post_ados'
            when age between 25 and 49  then 'Adultes'
            when age between 50 and 74  then 'Seniors'
            when age between 75 and  100  then 'Ainés'
            Else 'Inconnus'
        end as categories_age
from (
    select count(*) as nb_trip, (year(current_date()) - birth_year) as age from trips group by age
    )
group by categories_age ;


```

